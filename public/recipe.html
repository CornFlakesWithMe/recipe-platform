<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Details - FlavorShare</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body data-page="recipe-detail">
    <div class="page-wrapper">
        <header class="header">
            <div class="container">
                <a href="/" class="logo">
                    <span class="logo-icon">üç≥</span>
                    <span>FlavorShare</span>
                </a>
                <nav class="nav">
                    <button class="mobile-menu-btn" id="mobile-menu-btn">‚ò∞</button>
                    <ul class="nav-links" id="nav-links">
                        <li><a href="/" class="nav-link">Home</a></li>
                        <li><a href="/recipes.html" class="nav-link">Browse Recipes</a></li>
                        <li><a href="/create-recipe.html" class="nav-link">Add Recipe</a></li>
                    </ul>
                    <div class="nav-actions">
                        <div id="auth-buttons">
                            <a href="/login.html" class="btn btn-ghost">Log In</a>
                            <a href="/register.html" class="btn btn-primary">Sign Up</a>
                        </div>
                        <div id="user-menu" class="d-none">
                            <a href="/profile.html" class="btn btn-ghost">
                                <span>üë§</span>
                                <span id="username-display">User</span>
                            </a>
                            <a href="#" id="logout-btn" class="btn btn-outline">Log Out</a>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <div id="alert-container"></div>

        <main>
            <div class="container">
                <div id="recipe-container" class="recipe-detail">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div id="reviews-section" class="reviews-section" style="max-width: 900px; margin: 0 auto;">
                    <!-- Reviews will be loaded here -->
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="container">
                <div class="footer-bottom">
                    <p>¬© 2024 FlavorShare. CIS 435 Full Stack Project.</p>
                </div>
            </div>
        </footer>
    </div>

    <script src="/js/app.js"></script>
    <script>
        let currentRecipe = null;

        async function initRecipeDetailPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const recipeId = urlParams.get('id');
            
            if (!recipeId) {
                document.getElementById('recipe-container').innerHTML = `
                    <div class="empty-state">
                        <h3>Recipe not found</h3>
                        <p>The recipe you're looking for doesn't exist.</p>
                        <a href="/recipes.html" class="btn btn-primary">Browse Recipes</a>
                    </div>
                `;
                return;
            }
            
            await loadRecipe(recipeId);
            await loadReviews(recipeId);
        }

        async function loadRecipe(recipeId) {
            const container = document.getElementById('recipe-container');
            
            try {
                const data = await RecipeAPI.getById(recipeId);
                currentRecipe = data.recipe;
                
                document.title = `${currentRecipe.title} - FlavorShare`;
                
                // Check favorite status
                let isFavorited = false;
                if (currentUser) {
                    try {
                        const favStatus = await RecipeAPI.getFavoriteStatus(recipeId);
                        isFavorited = favStatus.isFavorited;
                    } catch (e) {}
                }
                
                // Check if current user is the owner
                const isOwner = currentUser && currentRecipe.author._id === currentUser.id;
                
                container.innerHTML = `
                    <div class="recipe-header">
                        <h1>${currentRecipe.title}</h1>
                        <div class="recipe-meta">
                            <span class="recipe-meta-item">
                                <span>üë§</span>
                                <span>By ${currentRecipe.author.username}</span>
                            </span>
                            <span class="recipe-meta-item">
                                <span>üìÖ</span>
                                <span>${formatDate(currentRecipe.createdAt)}</span>
                            </span>
                            <span class="recipe-meta-item">
                                <span class="star-rating">${renderStars(currentRecipe.averageRating)}</span>
                                <span>(${currentRecipe.totalRatings} reviews)</span>
                            </span>
                            <span class="recipe-meta-item">
                                <span>üëÅÔ∏è</span>
                                <span>${currentRecipe.views} views</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="recipe-image-container">
                        <img src="${currentRecipe.image || '/images/default-recipe.jpg'}" alt="${currentRecipe.title}">
                    </div>
                    
                    <div class="recipe-actions">
                        ${currentUser ? `
                            <button class="btn ${isFavorited ? 'btn-primary' : 'btn-outline'}" id="favorite-btn" onclick="toggleFavorite('${recipeId}')">
                                <span>${isFavorited ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                                <span>${isFavorited ? 'Saved' : 'Save Recipe'}</span>
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="window.print()">
                            <span>üñ®Ô∏è</span>
                            <span>Print</span>
                        </button>
                        ${isOwner ? `
                            <a href="/edit-recipe.html?id=${recipeId}" class="btn btn-outline">
                                <span>‚úèÔ∏è</span>
                                <span>Edit</span>
                            </a>
                            <button class="btn btn-danger" onclick="deleteRecipe('${recipeId}')">
                                <span>üóëÔ∏è</span>
                                <span>Delete</span>
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="d-flex gap-2 justify-center mb-4 flex-wrap">
                        <span class="difficulty-badge ${currentRecipe.difficulty}">${currentRecipe.difficulty}</span>
                        <span class="dietary-tag" style="background-color: var(--secondary-color);">${currentRecipe.category}</span>
                        ${currentRecipe.cuisine ? `<span class="dietary-tag" style="background-color: var(--accent-color);">${currentRecipe.cuisine}</span>` : ''}
                        ${currentRecipe.dietaryInfo?.vegetarian ? '<span class="dietary-tag">ü•¨ Vegetarian</span>' : ''}
                        ${currentRecipe.dietaryInfo?.vegan ? '<span class="dietary-tag">üå± Vegan</span>' : ''}
                        ${currentRecipe.dietaryInfo?.glutenFree ? '<span class="dietary-tag">üåæ Gluten-Free</span>' : ''}
                        ${currentRecipe.dietaryInfo?.dairyFree ? '<span class="dietary-tag">ü•õ Dairy-Free</span>' : ''}
                        ${currentRecipe.dietaryInfo?.nutFree ? '<span class="dietary-tag">ü•ú Nut-Free</span>' : ''}
                    </div>
                    
                    <div class="recipe-content">
                        <div class="recipe-sidebar">
                            <div class="mb-4">
                                <h3>‚è±Ô∏è Time</h3>
                                <p><strong>Prep:</strong> ${formatTime(currentRecipe.prepTime)}</p>
                                <p><strong>Cook:</strong> ${formatTime(currentRecipe.cookTime)}</p>
                                <p><strong>Total:</strong> ${formatTime(currentRecipe.prepTime + currentRecipe.cookTime)}</p>
                            </div>
                            
                            <div class="mb-4">
                                <h3>üçΩÔ∏è Servings</h3>
                                <p>${currentRecipe.servings} servings</p>
                            </div>
                            
                            <div>
                                <h3>ü•ò Ingredients</h3>
                                <ul class="ingredient-list">
                                    ${currentRecipe.ingredients.map(ing => `
                                        <li class="ingredient-item">
                                            <span>${ing.amount} ${ing.unit || ''} ${ing.name}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="recipe-main">
                            <div class="recipe-description">
                                <h3>üìù Description</h3>
                                <p>${currentRecipe.description}</p>
                            </div>
                            
                            <div>
                                <h3>üë®‚Äçüç≥ Instructions</h3>
                                <ol class="instruction-list">
                                    ${currentRecipe.instructions.map(inst => `
                                        <li class="instruction-item">
                                            <span class="instruction-number">${inst.stepNumber}</span>
                                            <span class="instruction-text">${inst.instruction}</span>
                                        </li>
                                    `).join('')}
                                </ol>
                            </div>
                            
                            ${currentRecipe.nutritionInfo && (currentRecipe.nutritionInfo.calories || currentRecipe.nutritionInfo.protein) ? `
                                <div class="mt-4">
                                    <h3>üìä Nutrition Info (per serving)</h3>
                                    <div class="d-flex gap-3 flex-wrap mt-2">
                                        ${currentRecipe.nutritionInfo.calories ? `<span class="dietary-tag" style="background: var(--gray-600);">üî• ${currentRecipe.nutritionInfo.calories} cal</span>` : ''}
                                        ${currentRecipe.nutritionInfo.protein ? `<span class="dietary-tag" style="background: var(--gray-600);">üí™ ${currentRecipe.nutritionInfo.protein}g protein</span>` : ''}
                                        ${currentRecipe.nutritionInfo.carbs ? `<span class="dietary-tag" style="background: var(--gray-600);">üçû ${currentRecipe.nutritionInfo.carbs}g carbs</span>` : ''}
                                        ${currentRecipe.nutritionInfo.fat ? `<span class="dietary-tag" style="background: var(--gray-600);">üßà ${currentRecipe.nutritionInfo.fat}g fat</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Recipe not found</h3>
                        <p>${error.message}</p>
                        <a href="/recipes.html" class="btn btn-primary">Browse Recipes</a>
                    </div>
                `;
            }
        }

        async function loadReviews(recipeId) {
            const container = document.getElementById('reviews-section');
            
            try {
                const data = await ReviewAPI.getForRecipe(recipeId);
                
                // Check if user can review
                let userReview = null;
                let canReview = false;
                if (currentUser) {
                    try {
                        const reviewCheck = await ReviewAPI.checkUserReview(recipeId);
                        userReview = reviewCheck.review;
                        canReview = !reviewCheck.hasReviewed && currentRecipe?.author?._id !== currentUser.id;
                    } catch (e) {}
                }
                
                container.innerHTML = `
                    <div class="reviews-header">
                        <h2 class="section-title">‚≠ê Reviews (${data.pagination.total})</h2>
                        ${canReview ? `<button class="btn btn-primary" onclick="showReviewForm()">Write a Review</button>` : ''}
                    </div>
                    
                    <div id="review-form-container" class="d-none mb-4">
                        <div class="card" style="padding: var(--spacing-lg);">
                            <h3 class="mb-3">Write Your Review</h3>
                            <form id="review-form">
                                <div class="form-group">
                                    <label class="form-label required">Rating</label>
                                    <div class="star-rating-input">
                                        <input type="radio" name="rating" value="5" id="star5" required>
                                        <label for="star5">‚òÖ</label>
                                        <input type="radio" name="rating" value="4" id="star4">
                                        <label for="star4">‚òÖ</label>
                                        <input type="radio" name="rating" value="3" id="star3">
                                        <label for="star3">‚òÖ</label>
                                        <input type="radio" name="rating" value="2" id="star2">
                                        <label for="star2">‚òÖ</label>
                                        <input type="radio" name="rating" value="1" id="star1">
                                        <label for="star1">‚òÖ</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="review-title" class="form-label">Title</label>
                                    <input type="text" id="review-title" name="title" class="form-input" placeholder="Sum up your review">
                                </div>
                                <div class="form-group">
                                    <label for="review-comment" class="form-label required">Review</label>
                                    <textarea id="review-comment" name="comment" class="form-textarea" placeholder="Share your experience with this recipe..." required minlength="10"></textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">Submit Review</button>
                                    <button type="button" class="btn btn-ghost" onclick="hideReviewForm()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div id="reviews-list">
                        ${data.reviews.length === 0 ? `
                            <div class="empty-state">
                                <p>No reviews yet. Be the first to review this recipe!</p>
                            </div>
                        ` : data.reviews.map(review => `
                            <div class="review-card">
                                <div class="review-header">
                                    <div class="review-author">
                                        <img src="${review.user.profileImage || '/images/default-avatar.png'}" alt="${review.user.username}" class="review-avatar">
                                        <div class="review-author-info">
                                            <h4>${review.user.username}</h4>
                                            <span>${formatDate(review.createdAt)}</span>
                                        </div>
                                    </div>
                                    <div class="star-rating">${renderStars(review.rating)}</div>
                                </div>
                                <div class="review-content">
                                    ${review.title ? `<h4>${review.title}</h4>` : ''}
                                    <p>${review.comment}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Setup review form
                const reviewForm = document.getElementById('review-form');
                if (reviewForm) {
                    reviewForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await submitReview(recipeId);
                    });
                }
                
            } catch (error) {
                container.innerHTML = '<p class="text-center">Failed to load reviews.</p>';
            }
        }

        function showReviewForm() {
            document.getElementById('review-form-container').classList.remove('d-none');
        }

        function hideReviewForm() {
            document.getElementById('review-form-container').classList.add('d-none');
        }

        async function submitReview(recipeId) {
            const form = document.getElementById('review-form');
            const formData = new FormData(form);
            
            try {
                await ReviewAPI.create(recipeId, {
                    rating: parseInt(formData.get('rating')),
                    title: formData.get('title'),
                    comment: formData.get('comment')
                });
                
                showAlert('Review submitted successfully!', 'success');
                await loadReviews(recipeId);
                await loadRecipe(recipeId);
                
            } catch (error) {
                showAlert(error.message || 'Failed to submit review', 'error');
            }
        }

        async function toggleFavorite(recipeId) {
            try {
                const data = await RecipeAPI.toggleFavorite(recipeId);
                const btn = document.getElementById('favorite-btn');
                
                if (data.isFavorited) {
                    btn.classList.remove('btn-outline');
                    btn.classList.add('btn-primary');
                    btn.innerHTML = '<span>‚ù§Ô∏è</span><span>Saved</span>';
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline');
                    btn.innerHTML = '<span>ü§ç</span><span>Save Recipe</span>';
                }
                
                showAlert(data.message, 'success');
            } catch (error) {
                showAlert(error.message || 'Failed to update favorite', 'error');
            }
        }

        async function deleteRecipe(recipeId) {
            if (!confirm('Are you sure you want to delete this recipe? This action cannot be undone.')) {
                return;
            }
            
            try {
                await RecipeAPI.delete(recipeId);
                showAlert('Recipe deleted successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/recipes.html';
                }, 1500);
            } catch (error) {
                showAlert(error.message || 'Failed to delete recipe', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initRecipeDetailPage, 100);
        });
    </script>
</body>
</html>
